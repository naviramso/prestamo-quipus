<div class="max-w-2xl mx-auto">
    <div class="bg-white p-6 rounded-lg shadow-sm border">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-800">Registrar Nuevo Administrador</h2>
                <p class="text-gray-600 text-sm">Crear nuevo usuario del sistema</p>
            </div>
            <a href="/admin/administradores/lista"
                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                ← Volver a la lista
            </a>
        </div>

        <!-- Verificación de permisos -->
        <% if (admin.rol !=='administrador' ) { %>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Permisos insuficientes</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <p>No tienes permisos para registrar nuevos administradores.</p>
                            <p class="mt-1">Solo los usuarios con rol "Administrador" pueden crear nuevos usuarios.</p>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>

                <form id="form-admin" class="space-y-6" <%=admin.rol !=='administrador' ? 'style="display: none;"' : ''
                    %>>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-800">Información sobre roles</h3>
                                <div class="mt-2 text-sm text-blue-700">
                                    <p><strong>Administrador:</strong> Acceso completo al sistema, puede crear/eliminar
                                        usuarios</p>
                                    <p><strong>Ver:</strong> Solo puede visualizar información, no puede modificar datos
                                        críticos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nombre Completo *
                            </label>
                            <input type="text" id="nombre" required placeholder="Ej: Juan Pérez García"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre de Usuario *
                                </label>
                                <input type="text" id="username" required placeholder="Ej: juan.perez"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors"
                                    pattern="[a-zA-Z0-9._]+" title="Solo letras, números, puntos y guiones bajos">
                                <p class="text-xs text-gray-500 mt-1">Solo letras, números, . y _</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Rol *
                                </label>
                                <select id="rol" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors">
                                    <option value="">Seleccionar rol</option>
                                    <option value="administrador">Administrador</option>
                                    <option value="ver">Ver</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Contraseña *
                                </label>
                                <input type="password" id="contrasenia" required placeholder="Mínimo 6 caracteres"
                                    minlength="6"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors">
                                <p class="text-xs text-gray-500 mt-1">Mínimo 6 caracteres</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Confirmar Contraseña *
                                </label>
                                <input type="password" id="confirmarContrasenia" required
                                    placeholder="Repetir contraseña" minlength="6"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors">
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit"
                            class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-md font-medium transition-colors flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Crear Administrador
                        </button>

                        <button type="button" onclick="window.location.href='/admin/administradores/lista'"
                            class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-md font-medium transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>

                <div id="mensaje" class="mt-6 p-4 rounded-md hidden"></div>
    </div>
</div>

<script>
    document.getElementById('form-admin').addEventListener('submit', async function (e) {
        e.preventDefault();

        const nombre = document.getElementById('nombre').value.trim();
        const username = document.getElementById('username').value.trim();
        const rol = document.getElementById('rol').value;
        const contrasenia = document.getElementById('contrasenia').value;
        const confirmarContrasenia = document.getElementById('confirmarContrasenia').value;

        const mensaje = document.getElementById('mensaje');
        mensaje.classList.add('hidden');

        // Validaciones
        if (!/^[a-zA-Z0-9._]+$/.test(username)) {
            mostrarMensaje('error', 'El nombre de usuario solo puede contener letras, números, puntos y guiones bajos.');
            return;
        }

        if (contrasenia !== confirmarContrasenia) {
            mostrarMensaje('error', 'Las contraseñas no coinciden.');
            return;
        }

        if (contrasenia.length < 6) {
            mostrarMensaje('error', 'La contraseña debe tener al menos 6 caracteres.');
            return;
        }

        try {
            const response = await fetch('/api/administradores', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nombre,
                    username,
                    rol,
                    contrasenia
                })
            });

            const data = await response.json();

            if (response.ok) {
                mostrarMensaje('success', data.mensaje);
                this.reset();

                // Redirigir después de 2 segundos
                setTimeout(() => {
                    window.location.href = '/admin/administradores/lista';
                }, 2000);
            } else {
                mostrarMensaje('error', data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarMensaje('error', 'Error de conexión. Intenta nuevamente.');
        }
    });

    function mostrarMensaje(tipo, texto) {
        const mensaje = document.getElementById('mensaje');
        mensaje.textContent = texto;
        mensaje.className = 'mt-6 p-4 rounded-md';

        if (tipo === 'success') {
            mensaje.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
        } else {
            mensaje.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
        }

        mensaje.classList.remove('hidden');

        if (tipo === 'success') {
            setTimeout(() => {
                mensaje.classList.add('hidden');
            }, 5000);
        }
    }

    // Auto-enfocar el primer campo
    document.getElementById('nombre').focus();
</script>